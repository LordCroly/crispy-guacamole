<!DOCTYPE html>
<html lang="pt-BR" class="antialiased dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poliedro - Udex Workspace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: { dark: '#050505', light: '#f4f4f5' },
                        surface: { dark: '#09090b', light: '#ffffff' }
                    }
                }
            }
        }
    </script>
    
    <!-- Motion One -->
    <script type="module">
        import { animate, spring } from "https://cdn.jsdelivr.net/npm/motion@10.16.2/+esm"
        window.Motion = { animate, spring };
    </script>

    <style>
        :root {
            --bg-app: #f4f4f5;
            --bg-surface: #ffffff;
            --text-main: #18181b;
            --text-muted: #71717a;
            --border-color: rgba(0, 0, 0, 0.08);
            --accent: #6366f1;
            --shadow-win: 0 10px 30px rgba(0,0,0,0.1);
        }

        .dark {
            --bg-app: #050505;
            --bg-surface: #09090b;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-win: 0 20px 50px rgba(0,0,0,0.5);
        }

        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #71717a; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        
        /* Layout */
        .sidebar { background-color: var(--bg-surface); border-right: 1px solid var(--border-color); }
        .header { background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color); }
        .input-field { background-color: var(--bg-app); border: 1px solid var(--border-color); color: var(--text-main); }
        
        /* Sidebar Animations */
        #mainSidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-inner { transition: opacity 0.2s ease-in-out; opacity: 1; width: 100%; }
        .sidebar-collapsed { width: 0 !important; border: none !important; }
        .sidebar-collapsed .sidebar-inner { opacity: 0; pointer-events: none; }

        /* Accordion */
        .accordion-content {
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            height: 0; opacity: 0; overflow: hidden;
        }
        
        select {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }

        /* Windows */
        .player-window {
            position: absolute;
            background-color: var(--bg-surface);
            box-shadow: var(--shadow-win), 0 0 0 1px var(--border-color);
            transition: box-shadow 0.2s;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .player-window:active { box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 0 1px var(--accent); z-index: 100 !important; }
        .window-header { background-color: var(--bg-app); border-bottom: 1px solid var(--border-color); color: var(--text-muted); }
        .resize-handle { position: absolute; width: 15px; height: 15px; right: 0; bottom: 0; cursor: nwse-resize; z-index: 20; }
        .lesson-item.active { background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent); color: var(--accent); }

        /* Sync Menu */
        .sync-menu {
            position: absolute; top: 100%; right: 0; margin-top: 0.5rem; width: 240px;
            background-color: var(--bg-surface); border: 1px solid var(--border-color);
            border-radius: 0.5rem; box-shadow: var(--shadow-win); padding: 1rem;
            opacity: 0; pointer-events: none; transform: translateY(-10px);
            transition: all 0.2s; z-index: 60;
        }
        .sync-menu.open { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Whiteboard & Toolbar */
        #whiteboardCanvas {
            position: absolute; inset: 0; width: 100%; height: 100%;
            touch-action: none; z-index: 0; cursor: crosshair;
        }
        
        .toolbar {
            position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%);
            background-color: var(--bg-surface); border: 1px solid var(--border-color);
            padding: 0.5rem; border-radius: 9999px; display: flex; gap: 0.5rem;
            box-shadow: var(--shadow-win); z-index: 50;
            transition: transform 0.2s;
        }
        .toolbar-btn {
            padding: 0.6rem; border-radius: 50%; color: var(--text-muted);
            transition: all 0.2s; position: relative;
        }
        .toolbar-btn:hover { background-color: var(--bg-app); color: var(--text-main); }
        .toolbar-btn.active { background-color: var(--accent); color: white; }
        
        /* NOTEBOOK STYLES (New) */
        .notebook {
            position: absolute; width: 320px; min-height: 250px;
            background-color: var(--bg-surface); border: 1px solid var(--border-color);
            border-radius: 0.5rem; box-shadow: var(--shadow-win);
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 100; opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        .notebook.visible { opacity: 1; pointer-events: auto; transform: scale(1); }
        .notebook:active { border-color: var(--accent); box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        
        .notebook-header {
            background-color: var(--bg-app); padding: 10px; cursor: grab;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); user-select: none;
        }
        .notebook-header:active { cursor: grabbing; }
        .notebook-title { font-weight: 600; font-size: 0.85rem; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        
        .win-controls { display: flex; gap: 6px; }
        .win-dot { width: 10px; height: 10px; border-radius: 50%; cursor: pointer; }
        .dot-close { background: #ef4444; } .dot-min { background: #eab308; } .dot-max { background: #22c55e; }
        
        .notebook textarea {
            flex: 1; background-color: var(--bg-surface); color: var(--text-main);
            border: none; padding: 15px; resize: none; /* Resize handled by container */
            font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem;
            outline: none; line-height: 1.6;
        }
        /* Resize handle for notebook */
        .notebook-resizer {
            position: absolute; bottom: 0; right: 0; width: 15px; height: 15px;
            cursor: nwse-resize; z-index: 10;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="h-14 header flex items-center justify-between px-4 z-50 shrink-0 transition-colors duration-300 relative">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" id="sidebarToggleBtn" class="p-1.5 rounded hover:bg-black/5 dark:hover:bg-white/5 text-zinc-500 hover:text-indigo-500 transition-colors">
                <i data-lucide="panel-left" class="w-5 h-5"></i>
            </button>
            <div class="w-px h-4 bg-zinc-300 dark:bg-zinc-700 mx-1"></div>
            <div class="flex items-center gap-2">
                <i data-lucide="brain-circuit" class="w-5 h-5 text-indigo-500"></i>
                <span class="font-bold text-sm tracking-wide text-zinc-800 dark:text-zinc-200">Udex</span>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/5 text-zinc-500 transition-colors">
                <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
            </button>

            <!-- Sync Wrapper -->
            <div class="relative">
                <button onclick="toggleSyncMenu()" id="syncBtn" class="text-xs font-medium text-zinc-500 hover:text-indigo-500 transition-colors flex items-center gap-1.5 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/5 rounded">
                    <i data-lucide="clock" class="w-3.5 h-3.5"></i> Sincronizar
                </button>
                <div id="syncMenu" class="sync-menu">
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-semibold text-zinc-500 uppercase">Tempo</span>
                            <button onclick="toggleSyncMenu()" class="text-zinc-400 hover:text-zinc-200"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <input type="text" id="syncTimeInput" placeholder="MM:SS" class="input-field w-full rounded px-2 py-1.5 text-sm text-center font-mono focus:border-indigo-500 outline-none" value="00:00">
                        <button onclick="applySync()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-2 rounded transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="refresh-ccw" class="w-3 h-3"></i> APLICAR
                        </button>
                    </div>
                </div>
            </div>

            <button onclick="resetLayout()" class="text-xs font-medium text-zinc-500 hover:text-red-500 transition-colors flex items-center gap-1.5 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/5 rounded">
                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Limpar
            </button>
            <!-- Wrapper do Seletor de Fundo -->
            <div class="relative">
                <button onclick="toggleBgMenu()" id="bgBtn" class="text-xs font-medium text-zinc-500 hover:text-indigo-500 transition-colors flex items-center gap-1.5 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/5 rounded">
                    <i data-lucide="grid" class="w-3.5 h-3.5"></i> Fundo
                </button>
                
                <!-- Menu Dropdown -->
                <div id="bgMenu" class="absolute top-full right-0 mt-2 w-40 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg shadow-xl p-1 hidden flex-col z-[60]">
                    
                    <button onclick="setBackground('dots')" class="text-left px-3 py-2 text-xs text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded flex items-center gap-2">
                        <div class="w-4 h-4 border border-zinc-300 rounded flex items-center justify-center"><div class="w-0.5 h-0.5 bg-zinc-500 rounded-full"></div></div> Pontilhado
                    </button>
                    
                    <button onclick="setBackground('grid')" class="text-left px-3 py-2 text-xs text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded flex items-center gap-2">
                        <div class="w-4 h-4 border border-zinc-300 rounded bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9InRyYW5zcGFyZW50Ii8+PHBhdGggZD0iTTAgNGg0TTAgMGg0IiBzdHJva2U9IiM5OTkiIHN0cm9rZS13aWR0aD0iMC41Ii8+PC9zdmc+')]"></div> Grade
                    </button>
                    
                    <button onclick="setBackground('lines')" class="text-left px-3 py-2 text-xs text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded flex items-center gap-2">
                        <div class="w-4 h-4 border border-zinc-300 rounded flex flex-col justify-center gap-0.5"><div class="w-full h-px bg-zinc-400"></div><div class="w-full h-px bg-zinc-400"></div></div> Pautado
                    </button>
                    
                    <button onclick="setBackground('none')" class="text-left px-3 py-2 text-xs text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded flex items-center gap-2">
                        <div class="w-4 h-4 border border-zinc-300 rounded bg-transparent"></div> Liso
                    </button>
                </div>
            </div>

        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar -->
        <aside id="mainSidebar" class="sidebar w-[380px] flex flex-col z-40 shrink-0">
            <div class="sidebar-inner flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-[var(--border-color)] space-y-3 bg-[var(--bg-surface)]">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-zinc-500"></i>
                        <input type="text" id="searchInput" placeholder="Buscar aula..." class="input-field w-full rounded px-9 py-2 text-sm focus:border-indigo-500 outline-none transition-all">
                    </div>
                    <select id="groupFilter" class="input-field w-full rounded px-3 py-2 text-xs text-zinc-500 focus:border-indigo-500 outline-none cursor-pointer">
                        <option value="month">üìÖ Por M√™s</option>
                        <option value="materia">üìö Por Mat√©ria</option>
                        <option value="frente">‚ö° Por Frente</option>
                        <option value="professor">üë®‚Äçüè´ Por Professor</option>
                    </select>
                </div>
                <div id="sidebarContent" class="flex-1 overflow-y-auto p-2 space-y-1 bg-[var(--bg-surface)]"></div>
                <div class="p-3 border-t border-[var(--border-color)] text-[10px] text-zinc-500 text-center flex justify-between items-center px-4 bg-[var(--bg-surface)]">
                    <span class="font-mono"><span id="lessonCount">0</span> AULAS</span>
                    <button onclick="toggleSidebar()" class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors p-1"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
<main class="flex-1 relative bg-[var(--bg-app)] overflow-hidden flex flex-col transition-colors duration-300">
            
            <div id="canvasArea" class="flex-1 overflow-y-auto overflow-x-hidden relative">
                
                <div id="scrollContent" class="relative w-full" style="min-height: 100%;">
                    
                    <canvas id="whiteboardCanvas" class="absolute top-0 left-0" style="touch-action: none; z-index: 10; cursor: crosshair;"></canvas>
                    
                    <div id="gridBackground" class="absolute inset-0 opacity-[0.08] dark:opacity-[0.09] pointer-events-none" style="background-image: radial-gradient(currentColor 1px, transparent 1px); background-size: 24px 24px; z-index: 0;"></div>
                    
                    <div id="windowsContainer" class="absolute top-0 left-0 w-full h-full" style="z-index: 20;"></div>
                    
                    <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none select-none transition-opacity duration-300" style="z-index: 30;">
                        <div class="w-16 h-16 rounded-2xl bg-[var(--bg-surface)] border border-[var(--border-color)] flex items-center justify-center mb-4 text-zinc-400 shadow-sm"><i data-lucide="layout-dashboard" class="w-8 h-8"></i></div>
                        <h1 class="text-lg font-medium text-zinc-500 dark:text-zinc-400">Workspace</h1>
                        <p class="text-zinc-400 dark:text-zinc-600 text-xs mt-1">Selecione uma aula ou comece a desenhar</p>
                    </div>
                </div>
            </div>

            <div id="notebook" class="notebook absolute z-[100]">
                <div class="notebook-header">
                    <span class="notebook-title"><i data-lucide="file-text" class="w-3.5 h-3.5 text-indigo-500"></i> Anota√ß√µes</span>
                    <div class="win-controls">
                        <span class="win-dot dot-min" onclick="toggleNotebook()" title="Ocultar"></span>
                        <span class="win-dot dot-close" onclick="clearNotebook()" title="Limpar"></span>
                    </div>
                </div>
                <textarea id="notebookContent" placeholder="Digite suas anota√ß√µes de estudo aqui..."></textarea>
                <div class="notebook-resizer"></div>
            </div>

            <div class="toolbar absolute bottom-6 left-1/2 -translate-x-1/2 z-[90]">
                <button class="toolbar-btn active" id="tool-cursor" onclick="setTool('cursor')" title="Mover"><i data-lucide="mouse-pointer-2" class="w-5 h-5"></i></button>
            <!-- Wrapper da Caneta -->
            <div class="relative">
                <button class="toolbar-btn" id="tool-pen" onclick="setTool('pen')" title="Caneta">
                    <i data-lucide="pen-tool" class="w-5 h-5"></i>
                </button>
                
                <!-- Popup da Caneta -->
                <div id="pen-popup" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg shadow-xl flex-col gap-3 w-[160px] z-[100]">
                    
                    <!-- Espessura -->
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Espessura</span>
                        <input type="range" id="penSizeInput" min="1" max="20" value="3" class="w-full h-1.5 bg-zinc-200 dark:bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                    </div>

                    <!-- Cores -->
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Cor</span>
                        <div class="flex flex-wrap gap-2 justify-between">
                            <!-- Auto (Preto/Branco) -->
                            <button onclick="setPenColor('auto')" class="w-5 h-5 rounded-full bg-zinc-900 dark:bg-zinc-100 border border-zinc-300 ring-offset-1 focus:ring-2 ring-indigo-500" title="Padr√£o"></button>
                            <!-- Vermelho -->
                            <button onclick="setPenColor('#ef4444')" class="w-5 h-5 rounded-full bg-red-500 border border-transparent ring-offset-1 focus:ring-2 ring-red-500"></button>
                            <!-- Azul -->
                            <button onclick="setPenColor('#3b82f6')" class="w-5 h-5 rounded-full bg-blue-500 border border-transparent ring-offset-1 focus:ring-2 ring-blue-500"></button>
                            <!-- Verde -->
                            <button onclick="setPenColor('#22c55e')" class="w-5 h-5 rounded-full bg-green-500 border border-transparent ring-offset-1 focus:ring-2 ring-green-500"></button>
                            <!-- Amarelo -->
                            <button onclick="setPenColor('#eab308')" class="w-5 h-5 rounded-full bg-yellow-500 border border-transparent ring-offset-1 focus:ring-2 ring-yellow-500"></button>
                        </div>
                    </div>
                    
                    <!-- Seta decorativa -->
                    <div class="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white dark:bg-zinc-800 border-b border-r border-zinc-200 dark:border-zinc-700 rotate-45"></div>
                </div>
            </div>
                <!-- Wrapper relativo para posicionar o popup -->
                <div class="relative">
                    <button class="toolbar-btn" id="tool-eraser" onclick="setTool('eraser')" title="Borracha">
                        <i data-lucide="eraser" class="w-5 h-5"></i>
                    </button>
                    
                    <!-- Popup do Slider (Oculto por padr√£o) -->
                    <div id="eraser-popup" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 p-2 rounded-lg shadow-xl flex-col gap-2 items-center w-[140px] z-[100]">
                        <div class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider mb-1">Tamanho</div>
                        <input type="range" id="eraserSizeInput" min="5" max="150" value="20" class="w-full h-1.5 bg-zinc-200 dark:bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                        <!-- Setinha decorativa apontando para baixo -->
                        <div class="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white dark:bg-zinc-800 border-b border-r border-zinc-200 dark:border-zinc-700 rotate-45"></div>
                    </div>
                </div>
                <div id="eraser-controls" class="hidden items-center mx-2 border-l border-zinc-300 dark:border-zinc-700 pl-2">
                    <input type="range" id="eraserSizeInput" min="5" max="150" value="20" class="w-20 h-1.5 bg-zinc-200 rounded-lg appearance-none cursor-pointer dark:bg-zinc-700 accent-indigo-500" title="Tamanho da Borracha">
                </div>
                <button class="toolbar-btn" id="tool-text" onclick="toggleNotebook()" title="Bloco de Notas"><i data-lucide="book-open" class="w-5 h-5"></i></button>
                <div class="w-px h-6 bg-zinc-300 dark:bg-zinc-700 mx-1 self-center"></div>
                <button class="toolbar-btn" onclick="undo()" title="Desfazer (Ctrl+Z)"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                <button class="toolbar-btn" onclick="redo()" title="Refazer (Ctrl+Shift+Z)"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                <div class="w-px h-6 bg-zinc-300 dark:bg-zinc-700 mx-1 self-center"></div>
                <button class="toolbar-btn" onclick="exportPDF()" title="Baixar PDF"><i data-lucide="file-down" class="w-5 h-5"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- Core Variables ---
        let allLessons = [], activeLessonId = null, zIndexCounter = 100, isSidebarOpen = true;
        
        // --- Whiteboard Variables ---
        const canvas = document.getElementById('whiteboardCanvas');
        const canvasArea = document.getElementById('canvasArea');
        const ctx = canvas.getContext('2d');
        let painting = false;
        let currentTool = 'cursor';
        let history = [];
        let historyStep = -1;

        // --- Background Control ---
        window.toggleBgMenu = () => {
            const menu = document.getElementById('bgMenu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        };

        // Fecha o menu se clicar fora
        document.addEventListener('mousedown', (e) => {
            const menu = document.getElementById('bgMenu');
            const btn = document.getElementById('bgBtn');
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        });

        window.setBackground = (type) => {
            const gridEl = document.getElementById('gridBackground');
            
            // Remove estilos inline anteriores
            gridEl.style.backgroundImage = '';
            gridEl.style.backgroundSize = '';
            
            if (type === 'dots') {
                // Pontilhado (Original)
                gridEl.style.backgroundImage = 'radial-gradient(currentColor 1px, transparent 1px)';
                gridEl.style.backgroundSize = '24px 24px';
            } 
            else if (type === 'grid') {
                // Grade Quadriculada
                gridEl.style.backgroundImage = `
                    linear-gradient(to right, currentColor 1px, transparent 1px),
                    linear-gradient(to bottom, currentColor 1px, transparent 1px)
                `;
                gridEl.style.backgroundSize = '24px 24px';
            }
            else if (type === 'lines') {
                // Pautado (Linhas de caderno)
                gridEl.style.backgroundImage = 'linear-gradient(to bottom, currentColor 1px, transparent 1px)';
                gridEl.style.backgroundSize = '100% 32px'; // Altura da linha t√≠pica de caderno
            }
            else if (type === 'none') {
                // Liso
                gridEl.style.backgroundImage = 'none';
            }
            
            // Fecha o menu ap√≥s selecionar
            window.toggleBgMenu();
            
            // Opcional: Salvar prefer√™ncia no localStorage
            localStorage.setItem('Udex_bgType', type);
        };


        // --- Borracha & Cursor ---
        let eraserSize = 20;

        // --- NOVO: Vari√°veis da Caneta ---
        let penWidth = 3;
        let penColor = 'auto'; // 'auto' segue o tema, ou hexcode fixo

        // Listener do Slider da Caneta
        document.getElementById('penSizeInput').addEventListener('input', (e) => {
            penWidth = e.target.value;
        });

        // Fun√ß√£o para setar cor
        window.setPenColor = (color) => {
            penColor = color;
            // Feedback visual opcional: fecha o popup ap√≥s escolher cor? 
            // Por enquanto deixamos aberto para ajuste fino.
        };
        // ---------------------------------

        const cursorEl = document.getElementById('eraserCursor');
        const eraserPopup = document.getElementById('eraser-popup');
        const eraserInput = document.getElementById('eraserSizeInput');

        // Atualiza tamanho
        eraserInput.addEventListener('input', (e) => {
            eraserSize = e.target.value;
            updateCursor(lastMouseX, lastMouseY);
        });

        document.addEventListener('mousedown', (e) => {
            const eraserPopup = document.getElementById('eraser-popup');
            const penPopup = document.getElementById('pen-popup');
            
            // Fecha Borracha se clicar fora
            if (eraserPopup && !eraserPopup.contains(e.target) && !e.target.closest('#tool-eraser')) {
                eraserPopup.classList.add('hidden');
                eraserPopup.classList.remove('flex');
            }
            
            // Fecha Caneta se clicar fora
            if (penPopup && !penPopup.contains(e.target) && !e.target.closest('#tool-pen')) {
                penPopup.classList.add('hidden');
                penPopup.classList.remove('flex');
            }
        });


        // Rastreamento do Mouse Global
        let lastMouseX = 0, lastMouseY = 0;
        document.addEventListener('mousemove', (e) => {
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            updateCursor(e.clientX, e.clientY);
        });

        function updateCursor(x, y) {
            if (currentTool === 'eraser') {
                cursorEl.style.display = 'block';
                cursorEl.style.width = `${eraserSize}px`;
                cursorEl.style.height = `${eraserSize}px`;
                cursorEl.style.transform = `translate(${x - eraserSize/2}px, ${y - eraserSize/2}px)`; // Centraliza via JS para garantir
                cursorEl.style.left = '0px'; // Resetar pois usamos translate
                cursorEl.style.top = '0px';  // Resetar pois usamos translate
            } else {
                cursorEl.style.display = 'none';
            }
        }

        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            initIcons();
            resizeCanvas();

            const savedBg = localStorage.getItem('Udex_bgType') || 'dots';
            setBackground(savedBg);
            
            // Critical fix for offset: Observe resize on container
            const observer = new ResizeObserver(() => resizeCanvas());
            observer.observe(canvasArea);
            
            try {
                const res = await fetch('banco_aulas_web.json');
                allLessons = await res.json();
                allLessons.sort((a, b) => new Date(a.data.iso || 0) - new Date(b.data.iso || 0));
                document.getElementById('lessonCount').textContent = allLessons.length;
                renderSidebar();
            } catch(e) { console.error(e); }

            saveHistory();
            loadNotebook();
            
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                    e.preventDefault(); // Impede o navegador de reabrir abas fechadas
                    if (e.shiftKey) redo(); else undo();
                }
            });
        });

        // --- Whiteboard Logic ---
        function resizeCanvas() {
            const currentImg = new Image();
            if (historyStep >= 0) currentImg.src = history[historyStep];
            
            const container = document.getElementById('canvasArea');
            const scrollContent = document.getElementById('scrollContent');
            
            // S√≥ redimensiona a largura. A altura NUNCA diminui, apenas mant√©m ou cresce.
            const newWidth = container.clientWidth;
            const newHeight = Math.max(container.clientHeight, canvas.height || 0);

            canvas.width = newWidth;
            canvas.height = newHeight;
            
            if (scrollContent) scrollContent.style.height = `${newHeight}px`;

            if (historyStep >= 0) {
                currentImg.onload = () => ctx.drawImage(currentImg, 0, 0);
            }
        }

        // Fun√ß√£o que detecta proximidade do fundo e injeta mais espa√ßo
        function expandCanvasIfNeeded(y) {
            const threshold = 150; // Pixels de dist√¢ncia do fundo para acionar
            if (y > canvas.height - threshold) {
                const currentImg = canvas.toDataURL(); // Salva estado atual do desenho
                const additionalHeight = 600; // Cresce 600px por vez
                
                canvas.height += additionalHeight;
                document.getElementById('scrollContent').style.height = `${canvas.height}px`;
                
                const img = new Image();
                img.src = currentImg;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    // Atualiza o hist√≥rico atual para evitar que o "Undo" encolha a tela
                    if(historyStep >= 0) history[historyStep] = canvas.toDataURL();
                };
            }
        }

        function draw(e) {
            if (!painting) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top; 

            expandCanvasIfNeeded(y);

            ctx.lineCap = 'round';

            if (currentTool === 'pen') {
                // L√≥gica de Cor: Se for 'auto', decide pelo tema. Se n√£o, usa a cor fixa.
                if (penColor === 'auto') {
                    const isDark = document.documentElement.classList.contains('dark');
                    ctx.strokeStyle = isDark ? '#e4e4e7' : '#18181b';
                } else {
                    ctx.strokeStyle = penColor;
                }
                
                ctx.lineWidth = penWidth; // Usa a espessura vari√°vel
                ctx.globalCompositeOperation = 'source-over';
                
            } else if (currentTool === 'eraser') {
                ctx.lineWidth = eraserSize;
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                return;
            }

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }




        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
            
            const eraserPopup = document.getElementById('eraser-popup');
            const penPopup = document.getElementById('pen-popup');

            // Resetar popups
            eraserPopup.classList.add('hidden'); eraserPopup.classList.remove('flex');
            penPopup.classList.add('hidden'); penPopup.classList.remove('flex');

            if (tool === 'eraser') {
                document.getElementById('tool-eraser').classList.add('active');
                eraserPopup.classList.remove('hidden');
                eraserPopup.classList.add('flex');
            } 
            else if (tool === 'pen') {
                document.getElementById('tool-pen').classList.add('active');
                // Abre popup da caneta
                penPopup.classList.remove('hidden');
                penPopup.classList.add('flex');
            }
            else {
                document.getElementById(`tool-${tool}`).classList.add('active');
            }

            // (O c√≥digo do updateCursor foi removido conforme solicitado)

            const winContainer = document.getElementById('windowsContainer');
            if (tool === 'cursor') {
                winContainer.style.pointerEvents = 'auto';
                canvas.style.pointerEvents = 'none';
            } else {
                winContainer.style.pointerEvents = 'none';
                canvas.style.pointerEvents = 'auto';
            }
        }



        function startPosition(e) {
            painting = true;
            draw(e);
        }

        function endPosition() {
            if (painting) {
                painting = false;
                ctx.beginPath();
                saveHistory();
            }
        }

        
        // --- History ---
        function saveHistory() {
            historyStep++;
            if (historyStep < history.length) history.length = historyStep;
            history.push(canvas.toDataURL());
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreHistory();
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                restoreHistory();
            }
        }

        function restoreHistory() {
            const img = new Image();
            img.src = history[historyStep];
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        }

        // --- Notebook System ---
        const notebook = document.getElementById('notebook');
        const nbHeader = notebook.querySelector('.notebook-header');
        const nbContent = document.getElementById('notebookContent');
        const nbResizer = notebook.querySelector('.notebook-resizer');

        function toggleNotebook() {
            notebook.classList.toggle('visible');
            if (notebook.classList.contains('visible')) {
                document.getElementById('tool-text').classList.add('active');
                // Set default position if first open
                if (!notebook.style.left) {
                    notebook.style.left = '50px';
                    notebook.style.top = '50px';
                }
            } else {
                if(currentTool === 'text') setTool('cursor');
                else document.getElementById('tool-text').classList.remove('active');
            }
        }
        
        function clearNotebook() {
            if(confirm('Limpar anota√ß√µes?')) {
                nbContent.value = '';
                saveNotebook();
            }
        }

        // Notebook Drag & Resize
        makeElementDraggable(notebook, nbHeader);
        makeElementResizable(notebook, nbResizer);

        // Persistence
        function saveNotebook() {
            const state = {
                text: nbContent.value,
                left: notebook.style.left,
                top: notebook.style.top,
                width: notebook.style.width,
                height: notebook.style.height,
                visible: notebook.classList.contains('visible')
            };
            localStorage.setItem('Udex_notebook', JSON.stringify(state));
        }

        function loadNotebook() {
            const saved = JSON.parse(localStorage.getItem('Udex_notebook'));
            if (saved) {
                if (saved.text) nbContent.value = saved.text;
                if (saved.left) notebook.style.left = saved.left;
                if (saved.top) notebook.style.top = saved.top;
                if (saved.width) notebook.style.width = saved.width;
                if (saved.height) notebook.style.height = saved.height;
                if (saved.visible) toggleNotebook();
            }
        }
        
        nbContent.addEventListener('input', saveNotebook);
        new ResizeObserver(saveNotebook).observe(notebook);
        // Save position on mouseup after drag
        nbHeader.addEventListener('mouseup', saveNotebook);

        // --- Export PDF Fidedigno (Pixel-Perfect) ---
        window.exportPDF = async () => {
            const { jsPDF } = window.jspdf;
            const nbEl = document.getElementById('notebook');
            
            // 1. Configura√ß√£o do PDF
            // Detecta orienta√ß√£o baseada no tamanho atual (Scroll Infinito)
            const orientation = canvas.width > canvas.height ? 'l' : 'p';
            const pdf = new jsPDF(orientation, 'px', [canvas.width, canvas.height]);
            const isDark = document.documentElement.classList.contains('dark');

            // 2. Fundo S√≥lido
            pdf.setFillColor(isDark ? 5 : 244, isDark ? 5 : 244, isDark ? 5 : 245);
            pdf.rect(0, 0, canvas.width, canvas.height, 'F');

            // 3. Grid (Pontinhos)
            const gap = 24; 
            pdf.setFillColor(isDark ? 50 : 200, isDark ? 50 : 200, isDark ? 50 : 200);
            for (let x = 0; x < canvas.width; x += gap) {
                for (let y = 0; y < canvas.height; y += gap) {
                    pdf.circle(x, y, 0.8, 'F');
                }
            }
            
            // 4. Desenho do Quadro (Tra√ßos)
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            
            // 5. Anota√ß√µes (Renderiza√ß√£o Fidedigna via html2canvas)
            if (nbEl && nbEl.classList.contains('visible')) {
                // Remove temporariamente a borda de sele√ß√£o/resize para a foto ficar limpa
                const resizer = nbEl.querySelector('.notebook-resizer');
                if(resizer) resizer.style.display = 'none';

                try {
                    // Tira "screenshot" do elemento DOM com alta qualidade (scale: 2)
                    const noteCanvas = await html2canvas(nbEl, {
                        backgroundColor: null, // Mant√©m transpar√™ncia se houver
                        scale: 2,              // Alta resolu√ß√£o para o PDF n√£o ficar borrado
                        logging: false,
                        useCORS: true
                    });

                    const noteImgData = noteCanvas.toDataURL('image/png');
                    
                    // C√°lculos de Posi√ß√£o
                    const rect = nbEl.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    // Posi√ß√£o exata relativa ao Canvas (considerando scroll)
                    const x = rect.left - canvasRect.left;
                    const y = rect.top - canvasRect.top;
                    const w = rect.width;
                    const h = rect.height;

                    // Insere a imagem da nota no PDF
                    pdf.addImage(noteImgData, 'PNG', x, y, w, h);

                } catch (err) {
                    console.error("Erro ao renderizar nota:", err);
                    alert("Erro ao salvar nota no PDF. O desenho foi salvo.");
                } finally {
                    // Restaura o visual original
                    if(resizer) resizer.style.display = 'block';
                }
            }
            
            pdf.save("Udex-quadro.pdf");
        };
        // --- Draggable Generic ---
        function makeElementDraggable(el, handle) {
            let isDragging = false, startX, startY, initialLeft, initialTop;
            handle.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('win-dot')) return;
                isDragging = true;
                startX = e.clientX; startY = e.clientY;
                initialLeft = el.offsetLeft; initialTop = el.offsetTop;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            function onMouseMove(e) {
                if (!isDragging) return;
                el.style.left = `${initialLeft + (e.clientX - startX)}px`;
                el.style.top = `${initialTop + (e.clientY - startY)}px`;
            }
            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }
        
        function makeElementResizable(el, handle) {
            let isResizing = false, startX, startY, startW, startH;
            handle.addEventListener('mousedown', (e) => {
                isResizing = true; e.preventDefault();
                startX = e.clientX; startY = e.clientY;
                startW = parseInt(document.defaultView.getComputedStyle(el).width, 10);
                startH = parseInt(document.defaultView.getComputedStyle(el).height, 10);
                document.addEventListener('mousemove', onResizeMove);
                document.addEventListener('mouseup', onResizeUp);
            });
            function onResizeMove(e) {
                if (!isResizing) return;
                el.style.width = `${startW + (e.clientX - startX)}px`;
                el.style.height = `${startH + (e.clientY - startY)}px`;
            }
            function onResizeUp() {
                isResizing = false;
                document.removeEventListener('mousemove', onResizeMove);
                document.removeEventListener('mouseup', onResizeUp);
            }
        }

        // --- Theme ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
        }
        if (localStorage.theme === 'light') document.documentElement.classList.remove('dark');

        // --- Sidebar ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('mainSidebar');
            const btn = document.getElementById('sidebarToggleBtn');
            isSidebarOpen = !isSidebarOpen;
            sidebar.classList.toggle('sidebar-collapsed', !isSidebarOpen);
            btn.classList.toggle('text-indigo-500', !isSidebarOpen);
            // Canvas resize handled by Observer automatically
        };

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            const filter = document.getElementById('groupFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            
            const filtered = allLessons.filter(l => l.topico.toLowerCase().includes(search) || l.materia.toLowerCase().includes(search));
            const groups = {};
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            filtered.forEach(l => {
                let key = l[filter] || 'Geral';
                if(filter === 'month' && l.data.iso) {
                    const d = new Date(l.data.iso);
                    key = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                }
                if(!groups[key]) groups[key] = [];
                groups[key].push(l);
            });

            Object.keys(groups).forEach(key => {
                const section = document.createElement('div');
                section.className = 'mb-1';
                const isOpen = search.length > 0;
                section.innerHTML = `
                    <button class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-left group" onclick="toggleAccordion(this)">
                        <div class="flex items-center gap-3">
                            <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-400 transition-transform duration-200 ${isOpen ? 'rotate-90' : ''}"></i>
                            <span class="text-xs font-bold text-zinc-500 group-hover:text-zinc-700 dark:text-zinc-400 dark:group-hover:text-zinc-200 uppercase tracking-wide transition-colors">${key}</span>
                        </div>
                        <span class="text-[9px] text-zinc-500 font-mono bg-black/5 dark:bg-white/5 px-1.5 py-0.5 rounded">${groups[key].length}</span>
                    </button>
                    <div class="accordion-content" style="${isOpen ? 'height: auto; opacity: 1' : ''}">
                        <div class="pl-2 pr-1 py-1 space-y-0.5">
                            ${groups[key].map(l => `
                                <div class="lesson-item pl-8 pr-3 py-2 rounded-md cursor-pointer lesson-hover text-zinc-500 dark:text-zinc-400 hover:text-indigo-600 dark:hover:text-white transition-all border-l-2 border-transparent" 
                                     onclick="loadLesson('${l.id}', this)">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-[9px] font-mono text-zinc-400">${l.data.texto}</span>
                                        <span class="text-[9px] font-bold opacity-70 uppercase tracking-wider">${l.materia.substring(0,8)}</span>
                                    </div>
                                    <div class="text-xs font-medium leading-snug truncate">${l.numero_aula}. ${l.topico}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(section);
            });
            initIcons();
        }

        window.toggleAccordion = (btn) => {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i');
            const isClosed = content.style.height === '0px' || content.style.height === '';
            if(isClosed) {
                content.style.height = content.scrollHeight + 'px';
                content.style.opacity = '1';
                icon.style.transform = 'rotate(90deg)';
                setTimeout(() => content.style.height = 'auto', 300);
            } else {
                content.style.height = content.scrollHeight + 'px';
                content.offsetHeight;
                content.style.height = '0px'; content.style.opacity = '0';
                icon.style.transform = 'rotate(0deg)';
            }
        };

        // --- Windows ---
        window.loadLesson = (id, el) => {
            document.querySelectorAll('.lesson-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const lesson = allLessons.find(l => l.id === id);
            const container = document.getElementById('windowsContainer');
            container.innerHTML = ''; 
            document.getElementById('emptyState').style.opacity = '0';
            setTool('cursor');
            lesson.arquivos.sort((a,b)=>a.parte-b.parte).forEach((file, idx) => createWindow(file, idx));
            if(window.innerWidth < 768) toggleSidebar();
        };

        function createWindow(file, index) {
            const win = document.createElement('div');
            win.className = 'player-window flex flex-col w-[480px] h-[300px] border border-[var(--border-color)]';
            
            // --- NOVA L√ìGICA DE POSICIONAMENTO (GRADE/SIDE-BY-SIDE) ---
            const winWidth = 480;
            const winHeight = 300;
            const gap = 20; // Espa√ßo entre janelas
            
            // Pega a largura dispon√≠vel na √°rea do canvas
            const containerArea = document.getElementById('canvasArea');
            const availableWidth = containerArea ? containerArea.clientWidth : window.innerWidth;
            
            // Calcula quantas colunas cabem por linha
            // (Subtra√≠mos um gap extra para margem de seguran√ßa)
            const cols = Math.floor((availableWidth - gap) / (winWidth + gap)) || 1;
            
            // Matem√°tica da Grade
            const row = Math.floor(index / cols); // Qual linha (0, 1, 2...)
            const col = index % cols;             // Qual coluna (0, 1, 2...)
            
            const x = gap + (col * (winWidth + gap));
            const y = gap + (row * (winHeight + gap));

            win.style.left = `${x}px`; 
            win.style.top = `${y}px`; 
            win.style.zIndex = zIndexCounter++;
            win.dataset.fileId = file.file_id;

            // Expande o Canvas automaticamente se a janela for criada muito abaixo
            const requiredHeight = y + winHeight + 100;
            const scrollContent = document.getElementById('scrollContent');
            if (canvas.height < requiredHeight) {
                canvas.height = requiredHeight;
                if(scrollContent) scrollContent.style.height = `${requiredHeight}px`;
                // Redesenha o hist√≥rico para n√£o esticar
                if(historyStep >= 0) {
                   const img = new Image();
                   img.src = history[historyStep];
                   img.onload = () => ctx.drawImage(img, 0, 0);
                }
            }

            // --- CONTE√öDO DA JANELA (MANTIDO IGUAL) ---
            win.innerHTML = `
                <div class="window-header h-9 flex items-center justify-between px-3 cursor-move active:cursor-grabbing group">
                    <div class="flex items-center gap-2">
                        <i data-lucide="grip-horizontal" class="w-3 h-3 text-zinc-400"></i>
                        <span class="text-[10px] font-bold uppercase tracking-wider">Parte ${file.parte}</span>
                    </div>
                    <button class="hover:text-red-500 transition-colors" onclick="this.closest('.player-window').remove()"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                </div>
                <div class="flex-1 bg-black relative">
                    <iframe src="https://drive.google.com/file/d/${file.file_id}/preview" class="absolute inset-0 w-full h-full border-0 pointer-events-auto" allow="autoplay"></iframe>
                    <div class="iframe-shield absolute inset-0 hidden bg-transparent"></div>
                </div>
                <div class="resize-handle"><div class="absolute right-1 bottom-1 w-2 h-2 border-r-2 border-b-2 border-zinc-400 dark:border-zinc-600"></div></div>
            `;
            
            document.getElementById('windowsContainer').appendChild(win);
            initIcons();
            
            // Fun√ß√µes de arrastar e redimensionar
            makeElementDraggable(win, win.querySelector('.window-header'));
            makeWindowResizable(win);
            
            win.addEventListener('mousedown', () => win.style.zIndex = zIndexCounter++);
            
            // Anima√ß√£o de entrada
            if(window.Motion) window.Motion.animate(win, { scale: [0.95, 1], opacity: [0, 1] }, { duration: 0.3 });
        }

        function makeWindowResizable(el) {
            const handle = el.querySelector('.resize-handle');
            const shield = el.querySelector('.iframe-shield');
            let isResizing = false, startX, startW; const aspectRatio = 16/9;
            handle.addEventListener('mousedown', (e) => {
                isResizing = true; e.preventDefault(); shield.classList.remove('hidden');
                startX = e.clientX; startW = parseInt(document.defaultView.getComputedStyle(el).width, 10);
                document.addEventListener('mousemove', onResizeMove); document.addEventListener('mouseup', onResizeUp);
            });
            function onResizeMove(e) { if (!isResizing) return; const newW = startW + (e.clientX - startX); if (newW > 240) { el.style.width = `${newW}px`; el.style.height = `${(newW / aspectRatio) + 36}px`; } }
            function onResizeUp() { isResizing = false; shield.classList.add('hidden'); document.removeEventListener('mousemove', onResizeMove); document.removeEventListener('mouseup', onResizeUp); }
        }

        // --- Sync ---
        window.toggleSyncMenu = () => document.getElementById('syncMenu').classList.toggle('open');
        window.applySync = () => {
            const timeStr = document.getElementById('syncTimeInput').value;
            const parts = timeStr.split(':');
            let totalSeconds = (parts.length === 2) ? (parseInt(parts[0]) * 60) + parseInt(parts[1]) : parseInt(parts[0]);
            document.querySelectorAll('.player-window').forEach(win => {
                const iframe = win.querySelector('iframe');
                if(win.dataset.fileId && iframe) iframe.src = `https://drive.google.com/file/d/${win.dataset.fileId}/preview?t=${totalSeconds}`;
            });
            toggleSyncMenu();
        };

        window.resetLayout = () => { 
            document.getElementById('windowsContainer').innerHTML = ''; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('emptyState').style.opacity = '1';
            saveHistory();
        };
        
        document.getElementById('searchInput').addEventListener('input', renderSidebar);
        document.getElementById('groupFilter').addEventListener('change', renderSidebar);
        function initIcons() { if(window.lucide) window.lucide.createIcons(); }
    </script>
    <!-- Cursor Personalizado da Borracha -->
    <div id="eraserCursor" class="fixed top-0 left-0 w-5 h-5 border-2 border-zinc-500 dark:border-white rounded-full pointer-events-none z-[9999] hidden -translate-x-1/2 -translate-y-1/2 shadow-sm" style="background-color: rgba(99, 102, 241, 0.15);"></div>
</body>
</html>
